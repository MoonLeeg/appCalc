<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Distributed Calculator</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container mt-5">
    <h1 class="text-center mb-4">Distributed Calculator</h1>

    <div id="authSection">
      <ul class="nav nav-tabs" id="authTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="login-tab" data-bs-toggle="tab" data-bs-target="#login" type="button" role="tab">Вход</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="register-tab" data-bs-toggle="tab" data-bs-target="#register" type="button" role="tab">Регистрация</button>
        </li>
      </ul>
      <div class="tab-content border border-top-0 p-4 bg-white" id="authTabContent">
        <div class="tab-pane fade show active" id="login" role="tabpanel">
          <form id="loginForm">
            <div class="mb-3">
              <label for="loginLogin" class="form-label">Логин</label>
              <input type="text" class="form-control" id="loginLogin" required>
            </div>
            <div class="mb-3">
              <label for="loginPassword" class="form-label">Пароль</label>
              <input type="password" class="form-control" id="loginPassword" required>
            </div>
            <button type="submit" class="btn btn-primary">Войти</button>
          </form>
        </div>
        <div class="tab-pane fade" id="register" role="tabpanel">
          <form id="registerForm">
            <div class="mb-3">
              <label for="regLogin" class="form-label">Логин</label>
              <input type="text" class="form-control" id="regLogin" required>
            </div>
            <div class="mb-3">
              <label for="regPassword" class="form-label">Пароль</label>
              <input type="password" class="form-control" id="regPassword" required minlength="6">
            </div>
            <button type="submit" class="btn btn-success">Зарегистрироваться</button>
          </form>
        </div>
      </div>
    </div>

    <div id="calcSection" class="mt-4" style="display: none;">
      <div class="card">
        <div class="card-body">
          <form id="calcForm" class="row g-2">
            <div class="col-9">
              <input type="text" id="expression" class="form-control" placeholder="Например, (2+3)*4" required>
            </div>
            <div class="col-3">
              <button type="submit" class="btn btn-primary w-100">Вычислить</button>
            </div>
          </form>
          <div id="error" class="alert alert-danger mt-3 d-none"></div>
          <div id="result" class="alert alert-success mt-3 d-none"></div>
        </div>
      </div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const apiBase = 'http://localhost:8080/api/v1';
    let token = '';

    function showSection(authenticated) {
      document.getElementById('authSection').style.display = authenticated ? 'none' : '';
      document.getElementById('calcSection').style.display = authenticated ? '' : 'none';
    }

    async function login(e) {
      e.preventDefault();
      clearAlerts();
      const login = document.getElementById('loginLogin').value.trim();
      const password = document.getElementById('loginPassword').value;
      try {
        const res = await fetch(`${apiBase}/login`, {
          method: 'POST', headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({login, password})
        });
        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();
        token = data.token;
        showSection(true);
      } catch(err) {
        alertError(err.message);
      }
    }

    async function registerFn(e) {
      e.preventDefault();
      clearAlerts();
      const login = document.getElementById('regLogin').value.trim();
      const password = document.getElementById('regPassword').value;
      try {
        const res = await fetch(`${apiBase}/register`, {
          method: 'POST', headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({login, password})
        });
        if (!res.ok) throw new Error(await res.text());
        alert('Регистрация прошла успешно, теперь войдите.');
        new bootstrap.Tab(document.querySelector('#login-tab')).show();
      } catch(err) {
        alertError(err.message);
      }
    }

    function clearAlerts() {
      document.getElementById('error').classList.add('d-none');
      document.getElementById('result').classList.add('d-none');
    }

    function alertError(msg) {
      const err = document.getElementById('error');
      err.textContent = msg;
      err.classList.remove('d-none');
    }

    async function calculate(e) {
      e.preventDefault();
      clearAlerts();
      const expr = document.getElementById('expression').value.trim();
      try {
        const res = await fetch(`${apiBase}/calculate`, {
          method: 'POST', headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`},
          body: JSON.stringify({expression: expr})
        });
        if (!res.ok) throw new Error(await res.text());
        const {id} = await res.json();
        pollResult(id);
      } catch(err) {
        alertError(err.message);
      }
    }

    async function pollResult(taskId) {
      const resultEl = document.getElementById('result');
      while(true) {
        const res = await fetch(`${apiBase}/expressions/${taskId}`, {headers: {'Authorization': `Bearer ${token}`}});
        const data = await res.json();
        if (data.status === 'done') {
          resultEl.innerHTML = `<strong>Ответ:</strong> ${data.result?.Float64 ?? 'Н/Д'}`;
          resultEl.classList.remove('d-none');
          break;
        }
        if (data.status === 'error') {
          alertError(`Ошибка вычисления выражения ID ${taskId}: ${data.error || 'Неизвестная ошибка'}`);
          break;
        }
        await new Promise(r => setTimeout(r, 500));
      }
    }

    document.getElementById('loginForm').addEventListener('submit', login);
    document.getElementById('registerForm').addEventListener('submit', registerFn);
    document.getElementById('calcForm').addEventListener('submit', calculate);
    showSection(false);
  </script>
</body>
</html> 